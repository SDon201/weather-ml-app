---
- name: Install prerequisites and deploy weather-ml-app to Kubernetes
  hosts: localhost
  gather_facts: true

  collections:
    - kubernetes.core

  vars:
    weather_ml_image: "sdon201/weather-ml-app:v1"
    weather_ml_replicas: 2
    minikube_deb_url: "https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb"
    minikube_deb_path: "/tmp/minikube_latest_amd64.deb"

  pre_tasks:
    #################################################################
    # Base packages (idempotent: re-running is safe)
    #################################################################
    - name: Ensure base packages are present
      become: true
      ansible.builtin.apt:
        update_cache: yes
        state: present
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - software-properties-common

    #################################################################
    # Docker – only install if missing
    #################################################################
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Install Docker if missing
      become: true
      ansible.builtin.apt:
        name: docker.io
        state: present
      when: docker_check.rc != 0

    - name: Ensure Docker service is running
      become: true
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started

    #################################################################
    # kubectl – check first, install binary only if missing
    #################################################################
    - name: Check if kubectl is installed
      ansible.builtin.command: kubectl version --client=true --output=yaml
      register: kubectl_check
      failed_when: false
      changed_when: false

    - name: Download kubectl binary if missing
      become: true
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        dest: /usr/local/bin/kubectl
        mode: "0755"
      when: kubectl_check.rc != 0

    #################################################################
    # Minikube – check + install if missing
    #################################################################
    - name: Check if Minikube is installed
      ansible.builtin.stat:
        path: /usr/bin/minikube
      register: minikube_stat

    - name: Download Minikube .deb if missing
      become: true
      ansible.builtin.get_url:
        url: "{{ minikube_deb_url }}"
        dest: "{{ minikube_deb_path }}"
        mode: "0644"
      when: not minikube_stat.stat.exists

    - name: Install Minikube if missing
      become: true
      ansible.builtin.apt:
        deb: "{{ minikube_deb_path }}"
      when: not minikube_stat.stat.exists

    #################################################################
    # Ensure Minikube cluster is running
    #################################################################
    - name: Check Minikube status (host)
      ansible.builtin.command: minikube status --format='{{.Host}}'
      register: minikube_status
      failed_when: false
      changed_when: false

    - name: Start Minikube if not running
      become: true
      ansible.builtin.command: minikube start --driver=docker
      when: minikube_status.stdout != "Running"

  tasks:
    #################################################################
    # Kubernetes Deployment + Service
    #################################################################
    - name: Apply weather-ml-app Deployment
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: weather-ml-app
            labels:
              app: weather-ml-app
          spec:
            replicas: "{{ weather_ml_replicas }}"
            selector:
              matchLabels:
                app: weather-ml-app
            template:
              metadata:
                labels:
                  app: weather-ml-app
              spec:
                containers:
                  - name: weather-ml-app
                    image: "{{ weather_ml_image }}"
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 5000

    - name: Ensure weather-ml-service Service exists
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: weather-ml-service
            labels:
              app: weather-ml-app
          spec:
            type: NodePort
            selector:
              app: weather-ml-app
            ports:
              - protocol: TCP
                port: 5000
                targetPort: 5000
                nodePort: 30001
